--- 
title_meta  : Chapter 4
title       : Application to Expression Data
description : "In this chapter, you will combine what you learned in the first three chapters to read in, tidy, and visualize gene expression data. Let's get started!"

--- type:NormalExercise key:2200ac0aae
## Putting it all together

Now that you've learned how to work with R, use `tidyr`/`dplyr` and `ggplot2` you will apply these skills to read in and visualize gene expression data.

We will read expression data for study [GSE55268](http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE55278). This study describes expression profiling of dendritic cells after infection with multiple strains of influenza viruses over an 8-hour time course. Read the abstract of [the associated publication](http://www.ncbi.nlm.nih.gov/pubmed/26223639) before continuing.

*** =instructions
- Hit 'Submit Answer' to continue

*** =pre_exercise_code
```{r}
# no pec
```

*** =sample_code
```{r}
```

*** =solution
```{r}
```

*** =sct
```{r}
success_msg("Now that you understand the study, let's get the data!")
```

--- type:NormalExercise  key:ecc45725c8
## Reading in the data
To get expression data from the Gene Expression Omnibus (GEO), you can use a package called `GEOquery` from Bioconductor. The size of the data prohibits us from running the code in DataCamp but we just wanted to show how simple it is.

*** =instructions
- Look at the code required to read expression data from GEO.
- Hit 'Submit Answer' to continue

*** =pre_exercise_code
```{r}
# no pec
```

*** =sample_code
```{r}
# library(GEOquery)
# geoList <- getGEO("GSE55278")
# eset <- geoList[[1]]
```

*** =solution
```{r}
# library(GEOquery)
# geoList <- getGEO("GSE55278")
# eset <- geoList[[1]]
```

*** =sct
```{r}
success_msg("Doesn't it look easy to read in data!?  Because the data is large, you'll be provided with a subset of the data in `eset` for the rest of the chapter.")
```

--- type:NormalExercise  key:483c4c5eb5
## ExpressionSet Objects

`GEOQuery` returns data in an object of the `ExpressionSet` class.  You can think of an `ExpressionSet` class as a container designed to combine multiple sources of information from a gene expression experiment into a single object. If interested, you can read more about this class [here](https://www.bioconductor.org/packages/devel/bioc/vignettes/Biobase/inst/doc/ExpressionSetIntroduction.pdf).

For this course, you need to know three functions to extract data from an `ExpressionSet`

- `pData`: Retreive information on experimental phenotypes (e.g. geo\_accession, Condition, Time)
- `fData`: Retrieve information on measured features (e.g. Entrez\_Gene\_ID, Symbol, Species)
- `exprs`: Retrieve expression data matrix

*** =instructions
- Print `eset` to get an overview of the expression data it contains.
- Create a new variable (`expr`) that contains the expression data from `eset`
- Create a new variable (`features`) that contains the feature data from `eset`
- Create a new variable (`phenotypes`) that contains the phenotype data from `eset`
- Click 'Submit Answer'.

*** =hint
Remember that if you want to assign values to a variable in R, you can make use of the assignment operator `<-`. Use the functions listed above to extract data from `eset`.

*** =pre_exercise_code
```{r}
load(url("http://s3.amazonaws.com/assets.datacamp.com/production/course_1843/datasets/eset.RData"))
```

*** =sample_code
```{r}
# Load Biobase package (from Bioconductor) to work with ExpressionSet Class
library(Biobase)

# Print eset


# Extract information out of eset into 3 new variables
```

*** =solution
```{r}
# Load Biobase package (from Bioconductor) to work with ExpressionSet Class
library(Biobase)                                        

# Print eset
print(eset)

# Extract information out of eset into 3 new variables
expr <- exprs(eset)
features <- fData(eset)
phenotypes <- pData(eset)
```

*** =sct
```{r}
test_student_typed(c("print(eset)", "eset", "show(eset)"),
                    fixed = TRUE, times = 1, 
                    not_typed_msg = "Have you printed the `eset` variable?")
# test_output_contains(print(eset), incorrect_msg = "Have you printed the `eset` variable?")
test_object("expr",
            undefined_msg = "Please make sure to define a variable `expr`.",
            incorrect_msg = "Have you set the variable `expr`?")
test_object("features",
            undefined_msg = "Please make sure to define a variable `fdat`.",
            incorrect_msg = "Have you set the variable `fdat`?")
test_object("phenotypes",
            undefined_msg = "Please make sure to define a variable `pdat`.",            
            incorrect_msg = "Have you set the variable `pdat`?")
success_msg("Great! Continue to the next exercise!")
```

--- type:NormalExercise  key:e7416248d9
## Tidy the data

Look at the class of `expr`. To tidy and work with this data you need to convert this matrix to a data frame. You can do this with the [`data.frame()`](http://www.rdocumentation.org/packages/base/functions/data.frame) function.

*** =instructions

- Create a new data frame called `expr_df` from `expr` using the [`data.frame()`](http://www.rdocumentation.org/packages/base/functions/data.frame) function.
- Combine `fdat` and `expr_df` into a new data frame called `exprf_df` again using the [`data.frame()`](http://www.rdocumentation.org/packages/base/functions/data.frame) function.
- Click 'Submit Answer'.

*Note: We set the global option `stringsAsFactors` to `FALSE` in the Workspace to avoid using the `factor` data type which we will not cover.*

*** =hint


*** =pre_exercise_code
```{r}
load(url("http://s3.amazonaws.com/assets.datacamp.com/production/course_1843/datasets/extractedEset.RData"))
options(stringsAsFactors = FALSE)
```

*** =sample_code
```{r}
# Convert expr into a data frame and name it expr_df


# Combine fdat and expr_df into a data frame named exprf_df
```

*** =solution
```{r}
# Convert expr into a data frame and name it expr_df
expr_df <- data.frame(expr)

# Combine fdat and expr_df into a data frame named exprf_df
exprf_df <- data.frame(fdat, expr_df)
```

*** =sct
```{r}
test_object("expr_df",
            undefined_msg = "Please make sure to define a variable `expr_df`.",
            incorrect_msg = "Have you set the variable `expr_df`?")
test_object("exprf_df", 
            undefined_msg = "Please make sure to define a variable `exprf_df`.",
            incorrect_msg = "Have you set the variable `expr_df`?")
success_msg("Great! Continue to the next exercise to continue tidying this expression data.")
```

--- type:NormalExercise   key:f53f507908
## Tidy the data (2)

Next you'll need to transform your data frame into a tidy format using [`gather()`](http://www.rdocumentation.org/packages/tidyr/functions/gather) so that there is only one observation (i.e. one gene measured in one sample) per row.

*** =instructions

- Use [`gather()`](http://www.rdocumentation.org/packages/tidyr/functions/gather) on `exprf_df` specifying the key as 'geo_accession' and the value as 'expression' and save this in a variable called `dat`
- Look at the structure of `dat` using the `str()` function

*** =hint
The [`gather()`](http://www.rdocumentation.org/packages/tidyr/functions/gather) function requires a key, value, and specification of which columns to gather.

You can specify all of the samples named by geo\_accession using `starts_with("GSM")`

*** =pre_exercise_code
```{r}
load(url("http://s3.amazonaws.com/assets.datacamp.com/production/course_1843/datasets/extractedEset.RData"))
options(stringsAsFactors = FALSE)
```

*** =sample_code
```{r}
library(tidyr)
library(dplyr)

# Convert expr into a data frame and name it expr_df
expr_df <- data.frame(expr)

# Combine fdat and expr_df into a data frame named exprf_df
exprf_df <- data.frame(fdat, expr_df)

# Gather expression columns of exprf_df and print structure of dat
```

*** =solution
```{r}
library(tidyr)
library(dplyr)

# Convert expr into a data frame and name it expr_df
expr_df <- data.frame(expr)

# Combine fdat and expr_df into a data frame named exprf_df
exprf_df <- data.frame(fdat, expr_df)

# Gather expression columns of exprf_df and print structure of dat
dat <- gather(data = exprf_df, key = geo_accession,
              value = expression, starts_with("GSM"))
str(dat)  
```

*** =sct
```{r}
# test_function("gather", args = c("data", "key", "value", "..."))
 test_object("dat",
             undefined_msg = "Please make sure to define a variable `dat`.",
             incorrect_msg = "Looks like `dat` is not set properly. Check your `gather()` call")
test_output_contains(str(dat), incorrect_msg = "Have you printed the structure of `dat`?")
success_msg("Great! Continue to the next exercise!")
```

--- type:NormalExercise key:ebeb4cda30
## Tidy the data (3)

Finally, you want to add phenotype data in `pdat` to `dat` so you have all the information describing the geo_accession (i.e. sample) in each row.

[`full_join()`](http://www.rdocumentation.org/packages/dplyr/functions/full_join) can be used to join two data frames and retain all values, and all rows.


*** =instructions

- Use [`full_join()`](http://www.rdocumentation.org/packages/dplyr/functions/full_join) to join `dat` and `pdat` by the "geo_accession" column and save the result in a new variabled called `data`

*** =hint

*** =pre_exercise_code
```{r}
load(url("http://s3.amazonaws.com/assets.datacamp.com/production/course_1843/datasets/extractedEset.RData"))
options(stringsAsFactors = FALSE)
```

*** =sample_code
```{r}
library(tidyr)
library(dplyr)

# Convert expr into a data frame and name it expr_df
expr_df <- data.frame(expr)

# Combine fdat and expr_df into a data frame named exprf_df
exprf_df <- data.frame(fdat, expr_df)

# Gather expression columns of exprf_df and print structure of dat
dat <- gather(data = exprf_df, key = geo_accession,
              value = expression, starts_with("GSM"))

# Join dat and pdat
```

*** =solution
```{r}
library(tidyr)
library(dplyr)

# Convert expr into a data frame and name it expr_df
expr_df <- data.frame(expr)

# Combine fdat and expr_df into a data frame named exprf_df
exprf_df <- data.frame(fdat, expr_df)

# Gather expression columns of exprf_df and print structure of dat
dat <- gather(data = exprf_df, key = geo_accession,
              value = expression, starts_with("GSM"))

# Join dat and pdat
data <- full_join(dat, pdat, by = "geo_accession")
```

*** =sct
```{r}
test_object("data",
            undefined_msg = "Please make sure to define a variable `data`.",
            incorrect_msg = "Looks like `data` is not set properly. Check your `full_join()` call")
success_msg("Great! Now that your data is tidy, it's time to start actually looking at it!")
```

<!-- TODO: Add another exercise to tidy this data using piping? -->

--- type:NormalExercise  key:9c603bbce2
## Plotting Gene Expression

Now for the fun part - exploring and visualizing the data!

You will start exploring by plotting the expression of one gene over time during a single influenza infection.


*** =instructions

- Plot the `expression` of the gene *MX1* over `Time` during the *Brevig* infection
time course.
  - First filter `data` to select observations where the `Symbol` is "MX1" and the `Treatment` is "Brevig" and save this in a new variable.
  - Then call `ggplot()` on this new variable and add `x` and `y` aesthetics using `aes()`.
  - Finally, add a `geom_point()` layer to the `ggplot()` call.

*** =hint

Remember to use `+` to add layers to the plotting call.

Review Chapter 3 if you forget what a `ggplot()` call should look like.

*** =pre_exercise_code
```{r}

load(url("http://s3.amazonaws.com/assets.datacamp.com/production/course_1843/datasets/extractedEset.RData"))
options(stringsAsFactors = FALSE)
```

*** =sample_code
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)

# Tidy data
# Note we are doing the same steps here using piping (%>%)
data <- data.frame(fdat, data.frame(expr)) %>%
  gather(key = geo_accession, value = expression, starts_with("GSM")) %>%
  full_join(pdat, by = "geo_accession")

# Filter the data


# Plot
```

*** =solution
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)

# Tidy data
# Note we are doing the same steps here using piping (%>%)
data <- data.frame(fdat, data.frame(expr)) %>%
  gather(key = geo_accession, value = expression, starts_with("GSM")) %>%
  full_join(pdat, by = "geo_accession")

# Filter the data
plotData <- data %>% filter(Symbol == "MX1", Treatment == "Brevig")

# Plot
ggplot(data = plotData, aes(x = Time, y = expression)) +
  geom_point() +
  theme_bw()
```

*** =sct
```{r}
test_ggplot(all_fail_msg = "Don't forget to make the plot! If you store the ggplot call in a variable `var` you can use `plot(var)` to make the plot",
            check_data = TRUE, data_fail_msg = "Make sure to provide the filtered data",
            check_aes = TRUE, aes_fail_msg = "Make sure you specify the `x` and `y` aesthetics in `aes()` to plot `Time` versus `expression`.",
            check_geom = TRUE, geom_fail_msg = "Add a `geom_point()` layer to create a scatter plot")
success_msg("Great job making that visualization! Let's spice it up a bit...")
```

--- type:NormalExercise  key:f548bed685
## Plotting Gene Expression (2)

--- type:NormalExercise  key:6a67c9447e
## Plotting Gene Expression (3)

--- type:NormalExercise  key:ae47d50b6a
## Data Interrogation


